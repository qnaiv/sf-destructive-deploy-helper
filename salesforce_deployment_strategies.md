# Salesforceの破壊的変更を伴うデプロイ戦略まとめ

Salesforceでカスタム項目やラベルなどのメタデータを削除（破壊的変更）する際、そのコンポーネントを参照しているApexクラスやレイアウトなどが原因で依存関係エラーが発生し、デプロイが失敗する問題があります。この問題を自動化・効率化するためのアプローチを以下にまとめます。

---

## 課題：手動での依存関係解決の限界

削除対象のコンポーネント（例: `Account.Legacy_Field__c`）がある場合、デプロイを成功させるには、その項目を参照しているすべてのApexクラス、Visualforceページ、レイアウト、フローなどを特定し、手動で修正（コメントアウトなど）してからデプロイする必要があります。このプロセスは非常に手間がかかり、ミスも発生しやすいです。

---

## アプローチ1：完全自動化カスタムツール（理想形）

コマンド一発で、依存関係の解決からデプロイまでを全自動で行うツールを設計するアプローチです。

### ワークフロー
1.  **差分検出**: `git diff` などでブランチ間の差分を検出し、削除されるコンポーネントを特定。
2.  **`destructiveChanges.xml` の自動生成**: 削除対象を元に、破壊的変更用のマニフェストファイルを生成。
3.  **依存関係の検索**: 削除対象のAPI名をキーに、プロジェクト内の全ソースコードを検索。
4.  **依存関係の自動無害化**: 見つかった参照箇所を一時的にコメントアウトする。
5.  **デプロイ実行**: 無害化されたソースと`destructiveChanges.xml`を使ってデプロイ。
6.  **クリーンアップ**: デプロイ後、ソースコードへの変更を元に戻す。

### 既存ツール
このワークフローを完全に実現する、広く使われている単一のツールは現状ありません。

---

## アプローチ2：既存のDevOpsツールやCLIプラグインの活用

既存のツールを利用して、問題を部分的に解決・支援するアプローチです。

### 1. Gearset, Copado
-   **機能**: 環境やブランチ間の差分を検出し、デプロイ前に依存関係の問題を自動で分析・警告してくれます（Problem Analyzer）。
-   **限界**: 問題を「通知」し、解決策を「提案」してくれますが、ソースコードの自動修正までは行いません。開発者が提案を元に手動で修正する必要があります。
-   **コスト**: 高機能ですが、高価な有償ツールです。

### 2. sfdx-git-delta (CLIプラグイン)
-   **機能**: Gitのブランチ間の差分を元に、変更・追加用の`package.xml`と、削除用の`destructiveChanges.xml`を自動生成します。
-   **限界**: 依存関係の解決は行わないため、このプラグインで生成したファイルでデプロイしても、依存関係エラーは発生します。
-   **コスト**: 無料のオープンソースです。

---

## アプローチ3：ハイブリッドアプローチ（現実的な最適解）

`sfdx-git-delta` と自作のスクリプトを組み合わせ、CLIでの自動化を実現するアプローチです。

### ワークフロー
1.  **ラッパースクリプトの実行**: 開発者は自作のスクリプト（シェル、Python等）を1つ実行します。
2.  **差分検出 (`sfdx-git-delta`)**: スクリプトが内部で`sfdx-git-delta`を実行し、`package.xml`と`destructiveChanges.xml`を生成します。
3.  **依存関係の特定**: スクリプトが`destructiveChanges.xml`を読み込み、削除対象のAPI名リストを取得します。
4.  **検索と無害化**: スクリプトがAPI名を元に`grep`等でソース内を検索し、見つかった箇所を`sed`等で一時的にコメントアウトします。（`git stash`で作業内容を退避させてから行うのが安全です）
5.  **デプロイ**: スクリプトが`sf project deploy start`を実行します。
6.  **復元**: スクリプトが`git stash pop`で、ソースコードを元の状態に戻します。

この方法は、既存の優れたツールを活用しつつ、足りない部分だけを補うことで、「コマンド一発でのデプロイ」という理想に近い形を低コストで実現できます。

---

## アプローチ4：組織スナップショット比較（Git非依存）

Gitの履歴ではなく、「Salesforce組織の現在の状態」を正として、ローカルソースとの差分を検出するアプローチです。

### ワークフロー
1.  **スナップショット作成**: `sf project retrieve`を使い、組織の全メタデータを一時ディレクトリに取得します。
2.  **差分比較**: ローカルの`force-app`ディレクトリと、スナップショットのディレクトリを`diff`コマンドで比較します。
3.  **マニフェスト生成**: `diff`の結果を解析し、`package.xml`と`destructiveChanges.xml`を動的に生成します。
4.  **デプロイ**: 生成したマニフェストを使ってデプロイします。

### メリット・デメリット
-   **メリット**: Gitに依存せず、組織の最新の状態と正確に同期できます。
-   **デメリット**:
    -   **パフォーマンス**: 全メタデータを取得する処理が非常に遅いです。
    -   **複雑さ**: `diff`結果の解析ロジックが複雑になります。
    -   **非推奨**: Gitを信頼できる情報源（Source of Truth）とするモダンな開発のベストプラクティスとは逆行します。

### 推奨される使い分け
-   **日常開発**: アプローチ3（ハイブリッドアプローチ）が高速で推奨されます。
-   **特別ケース**: Git管理されていないプロジェクトや、環境の同期が完全に崩れた場合のリセット用途には有効です。
