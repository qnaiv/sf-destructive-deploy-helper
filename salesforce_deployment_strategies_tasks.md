# Salesforce破壊的変更デプロイ支援ツール開発計画

## 概要
Salesforceのデプロイにおける破壊的変更（リソース削除）時の依存関係エラーを自動で解決するCLIツールを開発する。
以下の2つのアプローチを実装し、ユーザーが選択して実行できるようにする。

1.  **アプローチ3 (Git差分ベース)**: `sfdx-git-delta` を利用し、ブランチ間の差分からデプロイパッケージを生成し、依存関係を自動解決する。
2.  **アプローチ4 (組織スナップショット比較ベース)**: Salesforce組織の状態を直接取得し、ローカルソースとの差分からデプロイパッケージを生成する。

## 進捗状況
**フェーズ1: アプローチ3の実装完了。**

---

## フェーズ1: アプローチ3 (Git差分ベースのデプロイ)

このフェーズでは、`sfdx-git-delta` を活用したデプロイ自動化を実装する。

- [x] **タスク1.1: 基本的なシェルスクリプトの作成**
- [x] **タスク1.2: `sfdx-git-delta` の実行と差分パッケージの生成**
- [x] **タスク1.3: 破壊的変更内容の解析**
- [x] **タスク1.4: 依存関係の検索**
- [x] **タスク1.5: ソースコードの一時的な無害化処理**
- [x] **タスク1.6: デプロイコマンドの実行**
- [x] **タスク1.7: クリーンアップ処理の実装**
- [x] **タスク1.8: エラーハンドリングとユーザーフィードバック**

---

## フェーズ2: アプローチ4 (組織スナップショット比較ベースのデプロイ)

このフェーズでは、Gitに依存せず、Salesforce組織の状態を正としてデプロイパッケージを生成する機能を実装する。

- [x] **タスク2.1: モード選択機能の追加**
- [x] **タスク2.2: 組織スナップショットの取得**
- [x] **タスク2.3: ローカルソースとの差分比較**
- [x] **タスク2.4: 差分解析とマニフェスト生成**
- [ ] **タスク2.5: デプロイとクリーンアップ処理の統合** (タスク2.3, 2.4の実装に伴い、スクリプトに統合済み)

---

## 作業記録 (2025-07-02)

**状況:**
- フェーズ1「アプローチ3 (Git差分ベースのデプロイ)」の全タスクが完了。
- `sfdx-deploy-helper.sh` スクリプトは、Gitブランチ間の差分を基にした破壊的変更時の依存関係自動解決とデプロイを実行できる状態になった。
- `README.md` を作成し、ツールの概要と使用方法を記載した。
- `sfdx-deploy-helper.sh` にモード選択機能（タスク2.1）を追加した。
- `sfdx-deploy-helper.sh` の `org-snapshot` モードに、組織スナップショットの取得 (タスク2.2)、ローカルソースとの差分比較、差分解析とマニフェスト生成 (タスク2.3, 2.4) のロジックを追加した。デプロイとクリーンアップ処理も統合済み。

**中断理由:**
- GitHub CLI (`gh`) を用いたIssue作成時に、コマンドライン引数のエスケープに関する問題が発生し、自動でのIssue作成が困難であったため。

**次回作業:**
- GitHub CLI (`gh`) をより安定して利用するため、WSL (Windows Subsystem for Linux) 環境をセットアップする。
- WSL環境セットアップ後、GitHubのIssue、ブランチ、プルリクエストを活用するワークフローを開始する。

---

## WSL (Windows Subsystem for Linux) セットアップ手順

WSL (Windows Subsystem for Linux) を利用することで、Windows上でLinux環境を動かし、よりスムーズに開発作業を進めることができます。

**WSLのセットアップ手順:**

1.  **WSLの有効化:**
    管理者権限でPowerShellまたはコマンドプロンプトを開き、以下のコマンドを実行します。
    ```powershell
    wsl --install
    ```
    このコマンドは、WSLの有効化、WSL 2のインストール、およびUbuntuディストリビューションのインストールを一度に行います。
    もし、すでにWSLが有効になっている場合は、`wsl --install` コマンドは利用可能なディストリビューションのリストを表示するかもしれません。その場合は、`wsl --install -d Ubuntu` のように特定のディストリビューションを指定してインストールできます。

2.  **再起動:**
    インストールが完了したら、PCを再起動するよう求められる場合があります。再起動してください。

3.  **Linuxディストリビューションの初期設定:**
    再起動後、UbuntuなどのLinuxディストリビューションが自動的に起動し、ユーザー名とパスワードの設定を求められます。これらはWSL環境内でのみ使用されるものです。

4.  **GitHub CLIのインストール (WSL内):**
    WSL環境が起動したら、その中でGitHub CLIをインストールします。Ubuntuの場合、以下のコマンドでインストールできます。
    ```bash
    sudo apt update
    sudo apt install gh
    ```

5.  **GitHub CLIの認証 (WSL内):**
    WSL内でGitHub CLIを認証します。
    ```bash
    gh auth login
    ```
    指示に従って認証を完了してください。通常、ブラウザが開いて認証を行うことになります。

**WSL環境での作業:**

WSL環境が整ったら、`C:\Users\nochi\sf-destructive-deploy-helper` ディレクトリはWSL内から `/mnt/c/Users/nochi/sf-destructive-deploy-helper` としてアクセスできます。

今後の作業は、WSLのターミナルを開いて、このディレクトリに移動し、`gh` コマンドや `git` コマンドを実行することになります。
